# 低内存配置 (Low Memory Configuration)
#
# 此配置针对资源受限的设备优化（256MB-512MB RAM）
# 目标内存占用: ~50-70MB (空闲状态，包含前端)
#
# 使用方法:
#   ./opt-switch server -c config/settings.minimal.yml
#
# 适用场景:
#   - 内存 256MB-512MB 的设备
#   - 单用户或少并发场景（1-5 个用户）
#   - 需要使用 Web UI 管理界面
#   - 树莓派 3/4、光交换机等设备
#
# 优化内容:
#   ✓ 保留前端 Web UI（核心功能）
#   - 并发能力适度降低（建议 < 5 个并发用户）
#   - 禁用部分高级中间件（限流、监控）
#
# =============================================================================

settings:
  application:
    # 运行模式: dev开发模式（禁用验证码）
    mode: dev

    # 监听地址
    host: 0.0.0.0

    # 服务端口
    port: 8000

    # 读写超时（秒）
    readtimeout: 30
    writertimeout: 30

    # 数据权限功能开关
    enabledp: false

  logger:
    # 日志存放路径
    path: /tmp/opt-switch/logs

    # 控制台日志
    stdout: '1'

    # 日志等级 - error 级别减少日志量
    level: error

    # 数据库日志开关
    enableddb: false

  jwt:
    # token 密钥 - 生产环境请务必修改
    secret: opt-switch

    # token 过期时间（秒）
    timeout: 3600

  database:
    # 数据库类型
    driver: sqlite3

    # 数据库文件路径
    source: /tmp/opt-switch-db.db

    # === 数据库连接池（极低内存优化）===
    # 最大打开连接数（默认: 100）
    # minimal: 2（单用户场景足够）
    maxOpenConns: 2

    # 最大空闲连接数（默认: 10）
    # minimal: 1（减少内存占用）
    maxIdleConns: 1

    # 连接最大生存时间（秒）
    connMaxLifetime: 300

    # 空闲连接最大生存时间（秒）
    connMaxIdleTime: 60

  # === 内存队列配置（极低内存优化）===
  queue:
    memory:
      # 内存队列池大小（默认: 100）
      # minimal: 5（仅用于异步日志）
      poolSize: 5

  # 缓存配置
  cache:
    # 使用内存缓存
    memory: ''

    # Redis 缓存（minimal 不使用）
    # redis:
    #   addr: 127.0.0.1:6379
    #   password: ""
    #   db: 0

# =============================================================================
# 扩展配置（extend:）
# =============================================================================
# 注意：这些配置必须放在 extend: 节点下才能被 ExtConfig 读取
extend:
  # === 运行时内存调优 ===
  runtime:
    # 设置 GOMAXPROCS（默认: 0=自动）
    # 1 表示单核，减少 goroutine 调度开销
    # 适合单核 CPU 或低并发场景
    gomaxprocs: 1

    # 设置 GOGC（默认: 0=不改变）
    # 200 表示堆增长 200% 才触发 GC，减少 GC 频率
    # 节省 CPU 但可能增加单次 GC 暂停时间
    gogc: 200

    # 软内存限制（Go 1.19+，单位: MB）
    # 设置为 60MB，超过此值时 GC 更积极
    # 0 表示不限制
    memoryLimit: 60

    # 最大线程数（默认: 0=不限制）
    maxThreads: 0

  # === 应用程序扩展配置 ===
  applicationEx:
    # 前端静态文件（保留核心功能）
    enableFrontend: true

    # 中间件开关（禁用可节省 5MB）
    enableMiddleware:
      sentinel: false      # 限流中间件
      requestID: true      # 请求 ID 中间件（保留）
      metrics: false       # 指标收集中间件
      # 注意: Recovery, Logger, Auth 始终启用

# =============================================================================
# 内存优化说明
# =============================================================================
#
# 1. 连接池优化:
#    - maxOpenConns: 100 → 2 (-95%)
#    - maxIdleConns: 10 → 1 (-90%)
#
# 2. 队列优化:
#    - poolSize: 100 → 5 (-95%)
#
# 3. 运行时调优:
#    - GOMAXPROCS: 自动 → 1 (单核模式)
#    - GOGC: 100 → 200 (减少 GC 频率)
#    - MemoryLimit: 无 → 60MB (软限制)
#
# 4. 功能优化:
#    - 前端静态文件: 保留 (~15MB)
#    - Sentinel 中间件: 禁用 (节省 ~2MB)
#    - RequestID 中间件: 保留
#    - Metrics 中间件: 禁用 (节省 ~2MB)
#
# =============================================================================
#
# 预期内存占用（约）:
#   - Go 运行时: 20-30MB
#   - SQLite + 数据: 10-15MB
#   - 连接池: 2-3MB
#   - 队列: 1-2MB
#   - HTTP 服务: 3-5MB
#   - 前端静态文件: 15-20MB
#   - 总计: 约 50-70MB
#
# 适用场景:
#   - 内存: 256MB-512MB
#   - 并发用户: 1-5 人
#   - 使用模式: Web UI + API
#
# 不适用场景:
#   - 内存 < 256MB（建议升级硬件或使用纯 API 模式）
#   - 高并发场景（> 10 个用户）
#
# =============================================================================

# 其他配置
# 如果需要更高并发或有更多内存，请使用:
#   - config/settings.switch.yml  (60-80MB, 适合 512MB 设备)
#   - config/settings.yml          (80-100MB, 适合 > 512MB 设备)
