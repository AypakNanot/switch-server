# Implementation Tasks (Simplified)

## 1. 设备交互核心层 (pkg/device/)

- [ ] 1.1 定义核心接口和结构
  - [ ] 1.1.1 定义 ProtocolAdapter 接口
  - [ ] 1.1.2 定义 ConnectionConfig 结构体
  - [ ] 1.1.3 定义 CommandResult 结构体
  - [ ] 1.1.4 定义 DeviceConfig 结构体（配置文件映射）
  - [ ] 1.1.5 定义 ProtocolType 枚举

- [ ] 1.2 实现错误处理
  - [ ] 1.2.1 定义 DeviceError 结构体
  - [ ] 1.2.2 定义 ErrorCode 枚举（连接、队列、执行、配置错误）
  - [ ] 1.2.3 实现错误包装方法

- [ ] 1.3 实现 SSH 协议适配器
  - [ ] 1.3.1 实现 Connect 方法（支持密码认证）
  - [ ] 1.3.2 实现 Disconnect 方法
  - [ ] 1.3.3 实现 ExecuteCommand 方法
  - [ ] 1.3.4 实现 IsConnected 方法
  - [ ] 1.3.5 支持终端模式（PTY）
  - [ ] 1.3.6 实现超时控制

- [ ] 1.4 实现 Telnet 协议适配器
  - [ ] 1.4.1 实现 Connect 方法
  - [ ] 1.4.2 实现 Disconnect 方法
  - [ ] 1.4.3 实现 ExecuteCommand 方法
  - [ ] 1.4.4 实现 IsConnected 方法
  - [ ] 1.4.5 支持选项协商
  - [ ] 1.4.6 实现超时控制

- [ ] 1.5 实现连接池 + 命令队列
  - [ ] 1.5.1 定义 ConnectionPool 结构体（信号量模式）
  - [ ] 1.5.2 定义 CommandQueue 结构体
  - [ ] 1.5.3 定义 CommandTask 结构体
  - [ ] 1.5.4 实现 Acquire 方法（获取连接或排队）
  - [ ] 1.5.5 实现 Release 方法（释放连接）
  - [ ] 1.5.6 实现 Execute 方法（执行命令）
  - [ ] 1.5.7 实现连接超时机制
  - [ ] 1.5.8 实现队列超时机制
  - [ ] 1.5.9 实现并发安全控制
  - [ ] 1.5.10 实现连接状态监控

- [ ] 1.6 实现执行日志记录器
  - [ ] 1.6.1 定义 ExecutionLogger 结构体
  - [ ] 1.6.2 定义 ExecutionLog 结构体（JSON 格式）
  - [ ] 1.6.3 实现 Log 方法（记录执行日志）
  - [ ] 1.6.4 集成 zap lumberjack 日志滚动
  - [ ] 1.6.5 实现日志文件大小限制
  - [ ] 1.6.6 实现日志历史压缩
  - [ ] 1.6.7 实现日志查询方法（从文件尾部读取）

- [ ] 1.7 实现配置管理
  - [ ] 1.7.1 定义 DeviceConfig 结构体（配置文件映射）
  - [ ] 1.7.2 实现配置加载方法
  - [ ] 1.7.3 实现配置验证方法
  - [ ] 1.7.4 支持密码解密（可选加密格式）
  - [ ] 1.7.5 实现配置热加载（SIGHUP 或 API）

## 2. 业务逻辑层 (app/device/service/)

- [ ] 2.1 创建 DTO（数据传输对象）
  - [ ] 2.1.1 定义 CommandExecuteReq DTO（命令执行请求）
  - [ ] 2.1.2 定义 CommandExecuteResp DTO（命令执行响应）
  - [ ] 2.1.3 定义 BatchCommandReq DTO（批量命令请求）
  - [ ] 2.1.4 定义 BatchCommandResp DTO（批量命令响应）
  - [ ] 2.1.5 定义 CommandHistoryReq DTO（历史查询请求）
  - [ ] 2.1.6 定义 CommandHistoryResp DTO（历史查询响应）
  - [ ] 2.1.7 定义 DeviceStatusResp DTO（设备状态响应）

- [ ] 2.2 实现命令执行服务
  - [ ] 2.2.1 实现 ExecuteCommand 方法（单命令执行）
  - [ ] 2.2.2 实现 ExecuteBatch 方法（批量命令执行）
  - [ ] 2.2.3 实现 GetHistory 方法（查询执行历史）
  - [ ] 2.2.4 实现 GetStatus 方法（获取连接状态）
  - [ ] 2.2.5 实现用户信息提取（从 gin.Context）
  - [ ] 2.2.6 实现客户端 IP 提取

- [ ] 2.3 实现错误处理和日志记录
  - [ ] 2.3.1 集成错误码映射
  - [ ] 2.3.2 记录执行日志（异步）
  - [ ] 2.3.3 实现统一的响应格式

## 3. API 接口层 (app/device/apis/)

- [ ] 3.1 实现命令执行 API
  - [ ] 3.1.1 实现 ExecuteCommand API（POST /api/v1/device/command/execute）
  - [ ] 3.1.2 实现 ExecuteBatch API（POST /api/v1/device/command/batch）
  - [ ] 3.1.3 实现 GetHistory API（GET /api/v1/device/command/history）
  - [ ] 3.1.4 实现 GetStatus API（GET /api/v1/device/status）

- [ ] 3.2 添加中间件
  - [ ] 3.2.1 添加认证中间件（复用现有）
  - [ ] 3.2.2 添加权限控制中间件
  - [ ] 3.2.3 添加请求日志中间件

- [ ] 3.3 添加 Swagger 注解
  - [ ] 3.3.1 为所有 API 添加 Swagger 注解
  - [ ] 3.3.2 定义请求/响应模型
  - [ ] 3.3.3 生成 Swagger 文档

## 4. 路由配置 (app/device/router/)

- [ ] 4.1 创建设备路由
  - [ ] 4.1.1 初始化设备路由
  - [ ] 4.1.2 注册命令执行路由
  - [ ] 4.1.3 添加认证中间件
  - [ ] 4.1.4 添加权限控制中间件

- [ ] 4.2 集成到主路由
  - [ ] 4.2.1 在 app/admin/router/ 中注册设备路由

## 5. 配置管理

- [ ] 5.1 添加配置项
  - [ ] 5.1.1 在 config/settings.yml 中添加 device 配置段
  - [ ] 5.1.2 添加设备连接配置（host, port, protocol, username, password）
  - [ ] 5.1.3 添加连接池配置（max_connections, timeouts）
  - [ ] 5.1.4 添加日志配置（file, rotation）
  - [ ] 5.1.5 在 deploy/config/settings.switch.yml 中添加相同配置

- [ ] 5.2 实现配置加载
  - [ ] 5.2.1 在 config 包中添加 DeviceConfig 结构体
  - [ ] 5.2.2 实现配置初始化方法
  - [ ] 5.2.3 实现配置验证逻辑

- [ ] 5.3 可选：密码加密支持
  - [ ] 5.3.1 实现密码加密工具（AES-256-GCM）
  - [ ] 5.3.2 实现密码解密方法
  - [ ] 5.3.3 支持环境变量传入密钥

## 6. 权限配置

- [ ] 6.1 创建设备管理菜单
  - [ ] 6.1.1 添加设备命令执行菜单项
  - [ ] 6.1.2 添加执行历史查询菜单项

- [ ] 6.2 创建 API 权限
  - [ ] 6.2.1 注册命令执行 API 权限
  - [ ] 6.2.2 注册历史查询 API 权限

- [ ] 6.3 配置 Casbin 策略
  - [ ] 6.3.1 添加角色-权限映射
  - [ ] 6.3.2 初始化默认权限规则

## 7. 单元测试

- [ ] 7.1 协议适配器测试
  - [ ] 7.1.1 测试 SSH 适配器（需要 mock SSH 服务器）
  - [ ] 7.1.2 测试 Telnet 适配器（需要 mock Telnet 服务器）
  - [ ] 7.1.3 测试连接超时
  - [ ] 7.1.4 测试命令超时

- [ ] 7.2 连接池测试
  - [ ] 7.2.1 测试连接获取和释放
  - [ ] 7.2.2 测试连接池满时排队
  - [ ] 7.2.3 测试队列超时
  - [ ] 7.2.4 测试并发安全

- [ ] 7.3 业务逻辑测试
  - [ ] 7.3.1 测试命令执行服务（mock 协议适配器）
  - [ ] 7.3.2 测试批量命令执行
  - [ ] 7.3.3 测试日志记录

## 8. 集成测试

- [ ] 8.1 准备测试环境
  - [ ] 8.1.1 使用 Docker 模拟 SSH 服务器
  - [ ] 8.1.2 准备测试配置文件

- [ ] 8.2 端到端测试
  - [ ] 8.2.1 测试 SSH 命令执行完整流程
  - [ ] 8.2.2 测试 Telnet 命令执行完整流程
  - [ ] 8.2.3 测试批量命令执行
  - [ ] 8.2.4 测试连接池和队列
  - [ ] 8.2.5 测试多用户并发访问
  - [ ] 8.2.6 测试错误处理
  - [ ] 8.2.7 测试日志文件生成和查询

## 9. 文档编写

- [ ] 9.1 API 文档
  - [ ] 9.1.1 生成 Swagger 文档
  - [ ] 9.1.2 编写 API 使用示例

- [ ] 9.2 配置文档
  - [ ] 9.2.1 编写配置文件说明
  - [ ] 9.2.2 编写配置示例

- [ ] 9.3 开发文档
  - [ ] 9.3.1 编写架构设计文档
  - [ ] 9.3.2 编写协议扩展指南

## 10. 部署和验证

- [ ] 10.1 构建和部署
  - [ ] 10.1.1 构建项目
  - [ ] 10.1.2 部署到测试环境
  - [ ] 10.1.3 部署到交换机环境

- [ ] 10.2 验证测试
  - [ ] 10.2.1 功能验证测试
  - [ ] 10.2.2 性能测试（多用户并发）
  - [ ] 10.2.3 内存占用测试
  - [ ] 10.2.4 安全测试

## Dependencies

- **必须先完成**：1.1（接口定义）
- **依赖 1.1**：1.2（错误处理）、1.3-1.4（协议适配器）、1.5（连接池）
- **依赖核心层**：2（业务逻辑）、3（API 层）
- **可并行**：4（路由）、5（配置）、6（权限）
- **最后进行**：7-10（测试、文档、部署）

## Parallelizable Work

- 1.3（SSH 适配器）和 1.4（Telnet 适配器）可并行开发
- 2（业务逻辑）和 3（API 层）可部分并行
- 4（路由）、5（配置）、6（权限）可并行
- 7.1-7.2（单元测试）可在对应模块完成后进行

## Estimated Time

- 核心层（1）：2-3 天
- 业务层（2）：1 天
- API 层（3）：0.5 天
- 配置和权限（4-6）：0.5 天
- 测试（7-8）：1 天
- 文档和部署（9-10）：0.5 天

**总计：约 5-6 天**
